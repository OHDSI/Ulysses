<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Connecting Ulysses to ATLAS • Ulysses</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Connecting Ulysses to ATLAS">
<meta property="og:description" content="Ulysses">
<meta property="og:image" content="/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">Ulysses</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.0.6</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/atlas.html">Connecting Ulysses to ATLAS</a>
    </li>
    <li>
      <a href="../articles/credentials.html">Setting credentials</a>
    </li>
    <li>
      <a href="../articles/start_study.html">Creating a study using Ulysses</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://ohdsi.github.io/Hades" class="external-link"><img src='https://ohdsi.github.io/Hades/images/hadesMini.png' width=80 height=17 style='vertical-align: top;'></a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Connecting Ulysses to ATLAS</h1>
            
      
      
      <div class="hidden name"><code>atlas.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">Ulysses</span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>One of the first steps in putting together a study is adding cohorts.
In OHDSI studies we use cohorts defined using <code>circe</code>; a
software that serializes a series inputs into a standardized sql query.
Using <code>circe</code> allows us to build consistent definitions that
we can leverage across different sets of OMOP data and behind different
dbms’. For those familiar with OHDSI, building <code>circe</code>
cohorts can be done using the web application ATLAS. Within ATLAS, there
exists a very nice cohort designer interface. Cohort definitions built
in ATLAS are required for a study, so how do you gather them into
Ulysses? The purpose of this vignette is to show how users can import
atlas cohorts into a Ulysses study and give a pathway as to how to
generate them for the construction of a study pipeline.</p>
</div>
<div class="section level2">
<h2 id="ulysses-structure">Ulysses Structure<a class="anchor" aria-label="anchor" href="#ulysses-structure"></a>
</h2>
<p>Before getting into pulling ATLAS assets into your study, lets
quickly review how cohorts are stored in Ulysses. One of the standard
folders in a Ulysses directory is the cohorts folder. In this folder
there are three sub-folders: json, sql anc conceptSets/json. The json
folder is meant to host <code>circe</code> cohort definitions. These a
jsons exported out of ATLAS. The sql folder is meant to only host custom
sql that falls outside of the <code>circe</code> domain. These occur
when hacking <code>circe</code> sql to deal with cdm domains with lesser
coverage or when more extensive sql is required to derive a population
that cannot be captured with <code>circe</code>. The last section are
conceptSets. Concept sets are groupings of OMOP concepts that identify a
clinical idea of interest. You can think of them of “beefed-up”
code-lists. There are nice heirarchical properties that allow you to
cover many terms in a vocabulary in a concept set. These concept sets
also have a <code>circe</code> class and are stored as json objects. We
often use concept sets for characterization or building other cohort
definitions. Concept set jsons can be stored in
cohorts/conceptSets/json.</p>
<p>Ulysses standardizes the directory structure of a study to make it
easier to pull files within tasks. By storing all cohort and concept set
assets in a consistent location, it makes it easier to be organized and
build automation around this structure.</p>
</div>
<div class="section level2">
<h2 id="set-up-connection-with-atlas">Set up connection with ATLAS<a class="anchor" aria-label="anchor" href="#set-up-connection-with-atlas"></a>
</h2>
<p>Before you import you need to set up a connection to webApi. We do
this using keyring. Use the following code to do this:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">keyringName</span> <span class="op">&lt;-</span> <span class="st">"atlas"</span></span>
<span><span class="va">keyringPassword</span> <span class="op">&lt;-</span> <span class="st">"ohdsi"</span></span>
<span><span class="co"># setup a study keyring if it hasnt already been done</span></span>
<span><span class="fu"><a href="../reference/setStudyKeyring.html">setStudyKeyring</a></span><span class="op">(</span><span class="va">keyringName</span>, <span class="va">keyringPassword</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># add credentials for webapi</span></span>
<span><span class="va">creds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"baseurl"</span>, <span class="st">"authMethod"</span>, <span class="st">"user"</span>, <span class="st">"password"</span><span class="op">)</span></span>
<span><span class="va">db</span> <span class="op">&lt;-</span> <span class="st">'webapi'</span></span>
<span><span class="fu"><a href="../reference/setMultipleCredentials.html">setMultipleCredentials</a></span><span class="op">(</span></span>
<span>  creds <span class="op">=</span> <span class="va">creds</span>,</span>
<span>  db <span class="op">=</span> <span class="va">db</span>,</span>
<span>  keyringName <span class="op">=</span> <span class="va">keyringName</span>,</span>
<span>  keyringPassword <span class="op">=</span> <span class="va">keyringPassword</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">credNames</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">db</span>, <span class="va">creds</span>, sep <span class="op">=</span> <span class="st">"_"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">baseUrl</span> <span class="op">&lt;-</span> <span class="fu">keyring</span><span class="fu">::</span><span class="fu"><a href="https://keyring.r-lib.org/reference/key_get.html" class="external-link">key_get</a></span><span class="op">(</span>service <span class="op">=</span> <span class="va">credNames</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, keyring <span class="op">=</span> <span class="va">keyringName</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="importing-from-atlas">Importing from ATLAS<a class="anchor" aria-label="anchor" href="#importing-from-atlas"></a>
</h2>
<p>Ulysses offers some helper functions that allow users to import
assets into the study directory. These helper functions will evolve over
time and offer better services such as searches by tags and regular
expressions. Ulysses builds wrappers around a software called
<code>ROhdsiWebApi</code> which helps interface with the ATLAS api.</p>
<div class="section level3">
<h3 id="cohorts">Cohorts<a class="anchor" aria-label="anchor" href="#cohorts"></a>
</h3>
<p>To import a cohort, a user must know the cohort ids they want to pull
from ATLAS. Each cohort has a an ATLAS ID attached to it as a reference
number. Before importing, collect the cohort ids you want for the study.
Once these are collected you can adapt the following block:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/importAtlasCohorts.html">importAtlasCohorts</a></span><span class="op">(</span>cohortIds <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">4</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>This function will pull the cohort json for each cohort from the web
api and save tem to the cohorts/json folder within Ulysses. The files
are saved as a json under this schematic {atlasId}_{cohortName}, where
the cohort names are coerced into snakecase.</p>
</div>
<div class="section level3">
<h3 id="concept-sets">Concept Sets<a class="anchor" aria-label="anchor" href="#concept-sets"></a>
</h3>
<p>To import concept sets, users must know the concept set ids they want
to pull from ATLAS. Similar to the cohorts, collect the concept set ids
you want to use for the the study. Use this block to import concept
sets:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/importAtlasConceptSets.html">importAtlasConceptSets</a></span><span class="op">(</span>conceptSettIds <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">10</span>, <span class="fl">14</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="using-atlas-assets-within-ulysses">Using ATLAS assets within Ulysses<a class="anchor" aria-label="anchor" href="#using-atlas-assets-within-ulysses"></a>
</h2>
<p>Once you have imported the desired ATLAS assets into a Ulysses
directory, you can now use them for different task. For instance to
build <code>circe</code> cohorts, users can generate using
<code>CohortGenerator</code>. With a standard directory structure, it is
easy to prep <code>circe</code> json for generation. See an example
below:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># ulysses path</span></span>
<span><span class="va">ulysses_path</span> <span class="op">&lt;-</span> <span class="fu">here</span><span class="fu">::</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html" class="external-link">here</a></span><span class="op">(</span><span class="op">)</span> </span>
<span></span>
<span><span class="co"># path to cohorts folder</span></span>
<span><span class="va">path_to_circe</span> <span class="op">&lt;-</span> <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path.html" class="external-link">path</a></span><span class="op">(</span><span class="va">ulysses_path</span>, <span class="st">"cohorts/json"</span><span class="op">)</span> </span>
<span></span>
<span><span class="co"># list all circe json files in folder</span></span>
<span><span class="va">list_of_cohorts</span> <span class="op">&lt;-</span> <span class="va">path_to_circe</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/dir_ls.html" class="external-link">dir_ls</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"file"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># get the cohort names</span></span>
<span><span class="va">cohortName</span> <span class="op">&lt;-</span> <span class="va">list_of_cohorts</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path_file.html" class="external-link">path_file</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">tools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/tools/fileutils.html" class="external-link">file_path_sans_ext</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># set the ids, note this ranks by numeric atlas id</span></span>
<span><span class="va">cohortId</span> <span class="op">&lt;-</span> <span class="va">cohortName</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_order.html" class="external-link">str_rank</a></span><span class="op">(</span>numeric <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># import json into R</span></span>
<span><span class="va">circeJson</span> <span class="op">&lt;-</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map_chr</a></span><span class="op">(</span></span>
<span>  <span class="va">list_of_cohorts</span>,</span>
<span>  <span class="op">~</span><span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/read_file.html" class="external-link">read_file</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># serialize json to sql</span></span>
<span><span class="va">circeSql</span> <span class="op">&lt;-</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map_chr</a></span><span class="op">(</span></span>
<span>  <span class="va">circeJson</span>,</span>
<span>  <span class="op">~</span><span class="fu">CirceR</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/CirceR/reference/buildCohortQuery.html" class="external-link">buildCohortQuery</a></span><span class="op">(</span></span>
<span>    <span class="fu">CirceR</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/CirceR/reference/cohortExpressionFromJson.html" class="external-link">cohortExpressionFromJson</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span>,</span>
<span>    <span class="fu">CirceR</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/CirceR/reference/createGenerateOptions.html" class="external-link">createGenerateOptions</a></span><span class="op">(</span>generateStats <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># make input table for cohort generator</span></span>
<span><span class="va">cohortsToCreate</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>  cohortId <span class="op">=</span> <span class="va">cohortId</span>,</span>
<span>  cohortName <span class="op">=</span> <span class="va">cohortName</span>,</span>
<span>  json <span class="op">=</span> <span class="va">circeJson</span>,</span>
<span>  sql <span class="op">=</span> <span class="va">circeSql</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Generate the cohorts</span></span>
<span><span class="co"># place connection info appropriately</span></span>
<span><span class="fu">CohortGenerator</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/CohortGenerator/reference/generateCohortSet.html" class="external-link">generateCohortSet</a></span><span class="op">(</span></span>
<span>  connectionDetails <span class="op">=</span> <span class="va">connectionDetails</span>,</span>
<span>  cdmDatabaseSchema <span class="op">=</span> <span class="va">cdmDatabaseSchema</span>,</span>
<span>  tempEmulationSchema <span class="op">=</span> <span class="va">tempEmulationSchema</span>,</span>
<span>  cohortDatabaseSchema <span class="op">=</span> <span class="va">workDatabaseSchema</span>,</span>
<span>  cohortTableNames <span class="op">=</span> <span class="fu">CohortGenerator</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/CohortGenerator/reference/getCohortTableNames.html" class="external-link">getCohortTableNames</a></span><span class="op">(</span><span class="va">cohortTable</span><span class="op">)</span>,</span>
<span>  cohortDefinitionSet <span class="op">=</span> <span class="va">cohortsToCreate</span>,</span>
<span>  incremental <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  incrementalFolder <span class="op">=</span> <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path.html" class="external-link">path</a></span><span class="op">(</span><span class="fu">here</span><span class="fu">::</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html" class="external-link">here</a></span><span class="op">(</span><span class="st">"exec/logs"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Martin Lavallee.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
